<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
<title>Re:friend</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href='http://fonts.googleapis.com/css?family=Actor' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Finger+Paint|Geo&text=Re:friend' rel='stylesheet' type='text/css'>
<link rel="stylesheet" type="text/css" href="bootstrap.min.css" media="screen">
</head>
<body style="height: 100%">
<!-- This is the title and logout button on top of everything -->
<div id="theBox" class="container" style="height: 100%">
  <h1 style="height: calc(7% - 30px)">
    <span style="font-family: 'Geo'">Re<span style="color:red">:</span>
    </span>
    <span style="font-family: 'Finger Paint', cursive">friend</span>
    <button id="logout" onclick="logout1()" 
      style="float: right; display: none" 
      class="btn btn-info">Logout of FB
    </button>
  </h1>
  <!-- This is where the chat and login takes place -->
  <div id="jumbo" class="jumbotron" 
    style="height: calc(93% - 30px)">
    <!-- Prompt to login with facebook -->
    <div id="fb" style="height: 100%">
      <h1 style="font-family: Actor">Login with Facebook to get started</h1>
      <div id="fb-root"></div>
      <div style="text-align: center">
        <br>
        <button onclick="FB.login()" class="btn btn-primary">
          <div>
            Login with Facebook
            <img src="FBLogo.png">
            </img>
          </div>
        </button>
      </div>
      <h3>What is Re<span style="color:red">:</span>friend?</h3>
      <p style="text-align: justify">Re:friend is a facebook app that matches you to chat anonymously with another one of your friend using the app.</p>
    </div>
    <!-- Prompt to enter the queue for finding a friend-->
    <div id="queueEnter" style="display: none; height: 100%">
      <h3>Welcome!</h3>
      <p>Click the button below when you're ready to find a friend</p>
      <div syle="text-align: center">
        <button id="searchBtn" type="button" class="btn btn-default" 
          onclick="queueEnter()"
          style="display: block; margin-left: auto; margin-right: auto">
          Find a Friend
        </button>
      </div>
    </div>
    <!-- PLease wait screen -->
    <div id="wait" style="display: none; height: 100%">
      <div style="text-align: center">
        <p>Please wait while we find you a friend...</p>
        <img src="loading.gif"></img>
        <div id="tooLong" style="text-align: center" style="display: none">
          <small><p><br>
            Taking too long? Perhaps none of your friends use this app :(
            <br>Try sharing with a few people and playing a guessing game
            <br><br>While you wait, feel free to do other things but please keep this tab open in case one of your friends wants to chat</p>
          </small>
        </div>
      </div>
    </div> 
    <!-- The real chat interface -->
    <div id="app" style="display: none; height: 100%">
      <div id="messages" 
        style="height: calc(86% - 30px); overflow-y: auto; word-wrap: break-word">
      </div>
      <div id="typing" style="opacity: 0; height: 4%">Friend is typing...</div>

      <!-- Modal for asking if you would like to reveal -->
      <div class="modal fade" id="myModal">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" 
                aria-hidden="true"><span>x</span>
              </button>
              <h4 class="modal-title"><span>
                Identity Reveal</span>
              </h4>
            </div>
          <div class="modal-body">
            <div style="text-align: center">
              <div class="alert alert-danger" id="revealedYet" 
                style="display: block">
                Your friend has <b>not</b> decided to reveal him/herself yet
              </div>
              <div class="alert alert-success" id="revealedYet2" 
                style="display: none">
                Your friend has <b>already</b> decided to reveal him/herself
              </div>
              <button type="button" class="btn btn-primary" onclick="reveal()">
                Reveal Identity
              </button>
            </div>
            Click the button above if you wish to reveal your identity 
            to your friend. Your identities will be revealed to each other 
            if and when <b>both</b> of you decide to reveal them. If you 
            don't wish to reveal, simply close this.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              Close
            </button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <!-- Modal that tells you your friend's identity -->
    <div class="modal fade" id="myModal2">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" 
              aria-hidden="true"><span>x</span>
            </button>
            <h4 class="modal-title"><span>
              Identity Reveal</span>
            </h4>
          </div>
          <div class="modal-body">  
            <div style="text-align: center">
              You have both chosen to reveal your identities!
              <div class="alert alert-info" id="friendName" 
              style="text-align: center"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              Close
            </button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <!-- Buttons and input for chat -->  
    <div style="text-align: right; height: 4%">
      <a data-toggle="modal" href="#myModal" class="btn btn-primary" 
        id="reveal" style="float: left">Reveal Identity
      </a>
      <button id="dcButton" type="button" class="btn btn-default" 
        onclick="disconnect()">
        Disconnect
      </button>
    </div>
    <input type="text" id="msgInput" class="form-control input-sm"
    style="height: calc(6% - 2px)"
    placeholder="Your Message">
    </input>
  </div>
</div>


<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
<script src="bootstrap.min.js" type="text/javascript"></script>
<script src="http://refriend.herokuapp.com/socket.io/socket.io.js"></script>
<script type="text/javascript">
// adding messages to the chat box
var messagesElement = document.getElementById('messages');
var lastMessageElement = null;
function addMessage(message) {
  var newMessageElement = document.createElement('div');
  var newMessageText = document.createTextNode(message);
  newMessageElement.appendChild(newMessageText);
  messagesElement.appendChild(newMessageElement);
  messagesElement.scrollTop = messagesElement.scrollHeight;
}

var socket = io.connect('http://refriend.herokuapp.com');

//begin fb login

var handleResponse = function(response) {
    if (response.status === 'connected') {
      testAPI();
    } else if (response.status === 'not_authorized') {
      FB.login();
    } else {
      FB.login();
    }
  };

  window.fbAsyncInit = function() {
  FB.init({
    appId      : '495106743917197', // App ID
    channelUrl : '//http://refriend.herokuapp.com/channel.html', // Channel File
    status     : true, // check login status
    cookie     : false, // enable cookies to allow the server to access the session
    xfbml      : true  // parse XFBML
  });

  FB.Event.subscribe('auth.authResponseChange', handleResponse);
};

  // Load the SDK asynchronously
  (function(d){
   var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
   if (d.getElementById(id)) {return;}
   js = d.createElement('script'); js.id = id; js.async = true;
   js.src = "//connect.facebook.net/en_US/all.js";
   ref.parentNode.insertBefore(js, ref);
  }(document));


  // Here we run a very simple test of the Graph API after login is successful. 
  // This testAPI() function is only called in those cases. 
  function testAPI() {
    FB.api('/me', function(response) {
      var id_and_name = [response.id, response.name];
      socket.emit('login', id_and_name);
      document.getElementById('logout').style.display = 'block';
      if(document.getElementById('app').style.display == 'none' 
        && document.getElementById('wait').style.display == 'none') {
        $('#fb').attr('style', 'display: none');
        $('#queueEnter').attr('style', 'display: block');
      }
    });
    FB.api('/me/friends', function(res) {
      var friends = res.data;
      socket.emit('friends', friends);
    });
  }

//end fb login

var revealed = false;
var msgInterval = null;

//go into queue
function queueEnter() {
  document.getElementById('tooLong').style.display = 'none'
  document.getElementById('queueEnter').style.display = 'none';
  document.getElementById('app').style.display = 'none';
  document.getElementById('wait').style.display = 'block';
  var button = document.getElementById('dcButton');
  $(button).attr("onclick", "disconnect()");  
  button.innerHTML = 'Disconnect';
  socket.emit('queueEnter', "ready");
  messagesElement.innerHTML = '';
  document.title = "Re:friend";
  document.getElementById('msgInput').disabled = false;
  document.getElementById('typing').style.opacity = 0;
  revealed = false; 
  document.getElementById('revealedYet').style.display = 'block';
  document.getElementById('revealedYet2').style.display = 'none';
  if(msgInterval !== null)
    clearInterval(msgInterval);
  msgInterval = null;
  document.getElementById('reveal').href = '#myModal';
  $("#reveal").attr("disabled", false);
  document.getElementById('reveal').innerHTML = 'Reveal Identity';
  setTimeout(function() {
    document.getElementById('tooLong').style.display = 'block'
  }, 9000);
}

//goCheckQueue
socket.on('goCheckQueue', function(doIt) {
  socket.emit('queueCheck', 'doIt');
});

//actually checking the queue
socket.on('queueCheckGo', function(args) {
  var queue = args[0];
  var friends = args[1];
  var partner = -1;
  for (var i = 0; i < queue.length; i++) {
    for (var j = 0; j < friends.length; j++) {
      console.log('go');
      if (queue[i].fbId  == friends[j] /*&& queue[i].socketId != prev*/) {
        partner  = queue.splice(i, 1);
	break;
      }
    }
  }
  if (partner === -1)
    socket.emit('queueEnterSad', 'sad');
  else
    socket.emit('enterChat', partner[0].socketId);
});

//on good to go
socket.on('goodToGo', function(partner) {
  if(partner === false) {
    socket.emit('queueEnter', 'second time');
  }
  else {
    socket.emit('enterChatReal', partner);
  }
});

//join room
socket.on('joinRoom', function(room) {
  socket.emit('joinRoom', room);
});

//chat ready
socket.on('chatReady', function(ready) {
  document.getElementById('wait').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  addMessage('You are now connected with a friend!');
  document.title = "Re:friend - Friend Found";
});

//friend disconnect
socket.on('friendDisconnect', function(dc) {
  addMessage(dc);
  var button = document.getElementById('dcButton');
  $(button).attr("onclick", "queueEnter()");  
  button.innerHTML = 'New chat?';
  $('#msgInput').attr("disabled", true);
  socket.emit('disconnectMe2', 'sad');
  document.getElementById('typing').style.opacity = 0;
  $("#reveal").attr("disabled", true);
});

//disconnect
function disconnect()
{
  var button = document.getElementById('dcButton');
  $(button).attr("onclick", "queueEnter()");  
  button.innerHTML = 'New chat?';
  $('#msgInput').attr("disabled", true);
  $("#reveal").attr("disabled", true);
  socket.emit('disconnectMe', true);
  addMessage('You have disconnected');
}

//receive message
socket.on('serverMessage', function(content) {
  addMessage(content);
  if(content.charAt(0) !== "Y") {
    if (msgInterval !== null)
      clearInterval(msgInterval);
    msgInterval = setInterval(function() {
      if(document.title !== content)
        document.title = content;
      else {
        document.title = 'Re:friend';
      }
    }, 1000);
  }
});

//send message
function sendMessage(message) {
    socket.emit('clientMessage', message);
}

//sending messages with enter
var inputElement = document.getElementById('msgInput');
var typeOn = null;
var keyDown = false;

inputElement.onclick = function() {
    if (msgInterval !== null) {
      clearInterval(msgInterval);
      msgInterval = null;
      document.title = 'Re:friend';
    }
}

inputElement.onkeydown = function(keyboardEvent) {
  var trimmed = $.trim(inputElement.value);
  if (keyboardEvent.keyCode === 13 && trimmed !="") {
    sendMessage(inputElement.value);
    inputElement.value = '';
    socket.emit('typingNot', false);
    if (msgInterval !== null) {
      clearInterval(msgInterval);
      msgInterval = null;
      document.title = 'Re:friend';
    }
    return false;
  } else { //telling the other person is typing
    if(typeOn !== null)
      clearTimeout(typeOn);
    if (keyDown === false)
      socket.emit('typing', true);
    keyDown = true;
    return true;
  }
};

inputElement.onkeyup = function() {
  typeOn = setTimeout(function() { 
    socket.emit('typingNot', false);
    keyDown = false;
  }, 1000);
};



socket.on('typingNot', function() {
  document.getElementById('typing').style.opacity = 0;
});

socket.on('typing', function() {
  document.getElementById('typing').style.opacity = 0.8;
});

//logout
function logout1() {
  document.getElementById('logout').innerHTML = "Sure?";
  $("#logout").attr("onclick", "logout()"); 
}

function logout() {
  FB.logout(function(res) {
    console.log(res);
  });
  socket.emit('disconnectMe', true);
  document.getElementById('app').style.display = 'none' ;
  document.getElementById('wait').style.display = 'none';
  document.getElementById('queueEnter').style.display = 'none';
  document.getElementById('logout').style.display = 'none';
  document.getElementById('fb').style.display = 'block';
  document.getElementById('logout').innerHTML = "Logout of FB";
  $("#logout").attr("onclick", "logout1()");
}

//reveal identity
function reveal() {
  $("#myModal").modal('toggle');
  $("#reveal").attr("disabled", true);
  document.getElementById('reveal').innerHTML = 'Reveal Pending';
  socket.emit('reveal', true);
  revealed = true;
}

//on partner reveal
socket.on('reveal', function() {
  if(revealed === true){
    socket.emit('bothRevealed', true);
  }
  else {
    document.getElementById('revealedYet2').style.display = 'block';
    document.getElementById('revealedYet').style.display = 'none';
  }
});

//on revealTime
socket.on('revealTime', function() {
  socket.emit('revealMe', true);
});

//on bothRevealed
socket.on('bothRevealed', function(user) {
  var identity = "Your friend's identity is <b>" + user[0] + "</b>!<br><img src='https://graph.facebook.com/" + user[1] + "/picture'></img>";
   document.getElementById('friendName').innerHTML = identity;
  $('#myModal2').modal('show');
  document.getElementById('reveal').href = '#myModal2';
  document.getElementById('reveal').innerHTML = "Show Identity";
  $('#reveal').attr('disabled', false);
});

</script>
</body>
</html>

